(Day 34) 29-11-2025
~~~~~~~~~~~~~~~~~
Terraform
~~~~~~~~~~~~~~~~~
Terraform Installation Commands;
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
sudo yum -y install terraform
terraform --version

==> Terraform Refresh

5 instances
5 instances ----> Manually you have terminated 1 instance

==> Multi Region Resource Creation

alias

==> Terraform Import
10 instances - manually

terraform import can only do one task at a time

terraform import aws_instance

==> Migrating a state file - remote location
backend.tf ---> s3 bucket

=> Securing a state file
Dynamo DB - serverless service

Lock the statefile using Dynamo DB

==> Terraform Workspaces & Terraform Locals

dev ws
prod ws

terraform.tfstate.d


To create the resources in specific workspaces, we will use "locals" block



Contents; This demo is tested
1. Creation of VMs + Updating the Count + Changing the instance type (with userdata)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Note: Whenever we want to change the instance type - the public ip of VM will change as the instance has to be stopped during the instance type update

ðŸŒ SCENARIO â€” Creation of VMs + Updating the Count + Changing the instance type 
As we change the instance type, the public ips will change
~~~~~~~~~~~~~~~~
variables.tf
~~~~~~~~~~~~~~~~
variable "instance_count" {
  description = "Number of EC2 instances"
  type        = number
  default     = 2
}

variable "instance_name_prefix" {
  description = "Prefix for EC2 instances"
  type        = string
  default     = "web"
}

variable "instance_type" {
  description = "EC2 instance type"
  type        = string
  default     = "t2.micro"
}

variable "ami_id" {
  description = "AMI ID for EC2 instances"
  type        = string
  default     = "ami-0c02fb55956c7d316" # Amazon Linux 2 (example)
}


~~~~~~~~~~~~~~~~
main.tf
~~~~~~~~~~~~~~~~
provider "aws" {
  region = "us-east-1"
}

# Security Group
resource "aws_security_group" "web_sg" {
  name        = "web_sg"
  description = "Allow HTTP"
  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# Local map for VM names
locals {
  instance_keys = { for idx in range(var.instance_count) :
    "${var.instance_name_prefix}-${idx+1}" => idx }
}

# EC2 Instances
resource "aws_instance" "web" {
  for_each = local.instance_keys

  ami           = var.ami_id
  instance_type = var.instance_type
  key_name      = ""  # Optional: leave blank or specify key pair

  vpc_security_group_ids = [aws_security_group.web_sg.id]

  user_data = <<-EOF
              #!/bin/bash
              echo "<h1>Private IP: $(curl http://169.254.169.254/latest/meta-data/local-ipv4) | Instance: ${each.key}</h1>" > /var/www/html/index.html
              yum install -y httpd
              systemctl start httpd
              systemctl enable httpd
              EOF

  tags = {
    Name = each.key
  }
}

~~~~~~~~~~~~~~~~
outputs.tf
~~~~~~~~~~~~~~~~
output "instance_info" {
  value = { for k, v in aws_instance.web : k => {
    id        = v.id
    private_ip = v.private_ip
    type      = v.instance_type
  }}
}

~~~~~~~~~~~~~~~~
terraform.tfvars
~~~~~~~~~~~~~~~~
instance_count      = 2
instance_name_prefix = "web"
instance_type       = "t2.micro"
ami_id              = "ami-0c02fb55956c7d316"

~~~~~~~~~~~~~~~~
Commands
~~~~~~~~~~~~~~~~
terraform init
terraform plan
terraform approve --auto-approve
2 VMs get created
terraform state list

Update the instance count to 4 in tfvars file ----> and then execute ----> terraform approve --auto-approve ----> You will see 4 VMs
Update the instance type to t2.medium in tfvars file ----> and then execute ----> terraform approve --auto-approve ----> You will see 4 VMs type got changed

==============================
DevOps Overview
Linux
Git and GitHub
Maven
Tomcat
Jenkins
Nexus
SonarQube
S3
Docker
Kubernetes
Ansible
Terraform

Self-paced videos;

Shell Scripting - https://youtube.com/playlist?list=PLs-PsDpuAuTeT2iRQpNs0sl-sXFD10I1C&si=q2b1JwV8X0sqxlCT
Python - 
https://youtu.be/ERCMXc8x7mc?si=Rsbbb62k576xNyIm
https://youtube.com/playlist?list=PLsyeobzWxl7poL9JTVyndKe62ieoN-MZ3&si=NGIl574Bs1gIQ_iT
https://youtu.be/ix9cRaBkVe0?si=TB0IhXaylDf5AE12

Recommend: GitHub Actions, Service Mesh - Istio, OpenShift

Videos Link: https://youtube.com/playlist?list=PLs-PsDpuAuTfG3gFR5DnVD58kT7JBO97x&si=BfIl_9eIDq2YiPvR


















